#' Generate full dataset, possibly from compact data
#'
#' @param model A model object generated by \code{make_model()}.
#' @param n An integer. Number of observations.
#' @param parameters A numeric vector. Values of parameters may be specified. By default, parameters is drawn from priors.
#' @param using String indicating whether to use "priors", "posteriors" or "parameters". Defaults to "parameters".
#' @param w Vector of event probabilities can be provided directly. This is useful for speed for repeated data draws.
#' @param P A parameter matrix, can be used to generate w if w is not provided
#' @param A An ambiguity matrix, can be used to generate w if w is not provided
#' @return A data frame of simulated data.
#' @export
#'
#' @examples
#'
#' model <- make_model("X -> Y")
#'
#' # Simplest behavior uses by default  the parameter vector contained in model,
#' # which is flat by default:
#' simulate_data(model, n = 5)
#'
#' # Simulate multiple datasets is fastest if w is provided
#' w <- get_event_prob(model, using = "parameters")
#' replicate(5, simulate_data(model, n = 5, w = w))
#'

simulate_data <- function(model,
													n = 1,
													parameters = NULL,
													using = "parameters",
													w = NULL, P = NULL, A = NULL){

	# Check that parameters sum to 1 in each param_set
	if(!is.null(parameters)) parameters <- {
		model$parameters_df$parameters <- parameters
		gbiqq:::clean_params(model$parameters_df)$parameters}


  # Parameters called but not provided
	if(using == "parameters" & is.null(parameters)) parameters <- get_parameters(model)

	# Generate event probabilities w if missing
	if(is.null(w)){
		if(is.null(P)) 	P <- get_parameter_matrix(model)
		if(is.null(A)) 	A <- get_ambiguities_matrix(model)
		w <- get_event_prob(model, P, A, parameters = parameters, using = using)}

	# Data drawn here
	simulate_events(model, n = n,  parameters = parameters, using = using, w = w) %>%
		expand_data(model)

 }


